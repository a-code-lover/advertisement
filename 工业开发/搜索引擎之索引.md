
## 倒排索引(Inverted index)

### 什么是倒排索引和为什么需要倒排索引？

倒排索引是一种索引方式，建立“关键词---文档”的映射关系，现代搜索引擎大多采用的是倒排索引。倒排索引符合用户的搜索习惯，用户往往只会输入关键词，或者说我们在判断用户的搜索意图时，采用关键字标签来判别。

### 检索的基本流程

Step1：在分词系统对用户请求等原始Query进行分析，产生对应的terms；

Step2：terms在倒排索引中的词项列表中查找对应的terms的结果列表；

Step3：对结果列表数据进行微运算，如：计算文档静态分，文档相关性等；

Step4：基于上述运算得分对文档进行综合排序，最后返回结果给用户；

### 建立倒排索引关键

+ doc2term词项构建
+ 倒排记录表的构建

#### 词项构建

词项构建是构建索引必不可少的过程，词项的好坏直接影响到检索的效果和用户体验。

（1）文本词条化，对于中文来说语法复杂，语言的歧义很多，此时一般依赖NLP或者人工标注，然后在基于词典进行分词。而对于英文可空格进行分词。
（2）停用词过滤，停用词指那些出现频率较高但价值不大的词，如i, and , is等，用此类词建索引会生成多个全量文档索引列表。停用词过滤的使用往往依赖于实际使用场景，关键字查询使用得较为频繁的场景如某一个电商品牌的垂直型搜索引擎，一个合适的停用词表显得尤为重要；而对于Web搜索引擎如百度、Google等，该类型的搜索引擎面向的查询场景较多，通用性较强，往往不需要停用词过滤？？
（3）词条归一化，多个term表达同一个意思时，应当归一为同类。如color和colour, 苹果手机和iphone等。
（4）词干提取，词型还原，done、doing、did转化为do。

#### 倒排记录表构建

倒排记录表面向海量数据，无法完全写入内容，需要写到磁盘中。基本的构建方法为:  

S1: 通过一系列的处理将文档集合转化为“词项ID—文档ID”对；

S2: 对词项ID、文档ID进行排序，将具有相同词项对文档ID归并到该词项所对应的倒排记录表中；

S3: 将上述步骤产生的倒排索引写入磁盘，生成中间文件；

S4: 将上述所有的中间文件合并成最终的倒排索引；

从业务应用场景的角度出发，倒排记录表的构建方法主要有：单遍扫描和多遍扫描；从工程角度出发，倒排记录表的构建方法主要有：分布式构建和动态构建。

单遍扫描：快速建立倒排索引，通过关键词检索；单遍扫描构建索引由于其查询类型的丰富度不够，不能满足广大用户的需求，
多遍扫描：主要用于构建索引时获取关于文档的更多相关信息，如一些词项TF-IDF指标、词频、文档内容关系等，以丰富倒排记录表的内容，为搜索引擎进行功能扩充。
分布式构建：将倒排索引分割到多个机器上，检索时多个机器响应返回，最后将所有结果在内存中集中处理。
动态构建：该方法中的文档集合是变化的，这要求在对文档集进行索引构建时也要对文档的更新进行自适应。此问题常见于电商领域里，如商品的上下架、商品内容的更新等，都会引发索引的动态更新问题。

常见的策略如下两种：
1） 周期性对文档进行全量重建索引；
2） 基于主索引的前提下，构建辅助索引，用于储存新文档，维护于内存中，当辅助索引达到一定的内存占用时，写入磁盘与主索引进行合并；

参考来源：  
https://zhuanlan.zhihu.com/p/28320841

### 倒排索引分布式存储

有两种方案：多机分布式索引一般按照文档编号（DocId）或者按照索引词编号（WordId）进行划分。按照DocId划分的结果称为"局部倒排文件"（Local inverted file）；按照WordId划分的结果称为"全局倒排文件"（Global inverted file）。  
采用局部倒排文件的方案是相对有利的，在业界，一般认为局部方案的可靠性是必须的，因此主要应用了该方案。主要是以下两点：

（1）可靠性高，单个文件故障不会导致整个关键词无法查询。
（2）降低网络负载，提高查询效率。局部方案有利于并发地获取检索结果；而全局方案有利于查询并发。

### 单词词典

+ 哈希加链表
+ B/B+树

### 倒排链求交集并集

### 索引压缩

1.存储差值

## 全量索引

## 增量索引

参考：
[Lucene倒排索引实现原理探秘1，2，3](http://www.nosqlnotes.com/technotes/searchengine/lucene-invertedindex/)