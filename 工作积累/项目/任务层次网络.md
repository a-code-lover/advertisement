# 基于层次任务网络的任务重规划引擎

+ 基于JSHOP2框架验证飞行编队的自主任务规划的可行性，利用D3.js工具实现任务重规划流程的树形可视化；
+ 利用PDDL实现飞行编队的层次任务网络表示，制定任务重规划的底层规则，利用JSHOP2实现任务重规划，并通过修改JSHOP2源码，使得模块具备修改规划中间状态的能力；
+ 将项目布置到本地Tomcat服务器，实现前后端业务流程；
+ 通过socket通信与外部系统进行数据传递，实现c++/Java之间数据转换，并利用接收到的数据动态生成PDDL文件；
+ 构建PDDL可视化编辑工具，使得用户能够在可视化环境下编辑任务规则，降低用户的使用要求；

## 为什么使用jshop2框架？有其他的吗？

## 为什么使用任务层次网络？有什么优势？

## 规划的流程是怎么样的？

利用任务层次网络，层与层之间是上下级关系，同一层中间是偏序关系。按照常量提取，变量索引，层次划分，规则树匹配，生成结果。

## 项目介绍

本项目是由北邮和北大合作的无人机指控原型系统，主要分为三个部分：情景感知模块，任务重规划模块和任务自组织模块。我们小组做的是任务重规划模块，简单来说就是获取世界环境状态和自身状态，将状态和目标传到jshop2规划器中，根据规划器内部操作集合和方法集合的匹配，最终输出原子动作序列结果。同时通过将规划逻辑进行抽象，借助d3可视化工具实现全流程可视化。

## 难点

1.jshop2规划器自动规划，实际情况我们希望能够干预规划过程，增加程序交互性。jshop2规划器按层进行规划，每次规划只与当前节点有关，于是我们对规划过程进行单步提取，通过常量提取，变量索引，按层次匹配，把每次规划抽象成一个findplanhelper函数，在每次递归前，执行交互状态注入（检测是否需要进行状态更新，捕获状态事件），若有更新指令，则更新状态，若无则进行下一步规划。

findplanhelper()内部逻辑：
nextBingding(Predicate P, MyIteroter me)根据状态关键字对所有符合条件的问题域状态进行迭代，找出符合条件的赋值

2.JSHOP2时序问题
时序问题包括：无人机执行动作的先后顺序问题；执行动作持续时间问题；完整规划结束前任务状态改变 
1）无人机执行动作先后顺序问题：简单的任务先后问题可以利用JSHOP2的order关键字处理；复杂先后顺序问题，/*MTP（多重时间预处理技术）*/ 为每个消耗时间的操作符加上动作的开始时间，持续时间和读写时间。可以对这些时间进行数值计算来处理先后顺序问题。  
2）执行动作持续时间问题：利用添加的持续时间来进行表达和计算  
3）完整规划结束前任务状态改变：根据任务状态关键字设定触发器，当接受到新的任务状态时，选择是否结束之前的任务规划，执行新的任务规划。（目标发生改变）  

## 创新点

1.采用HTN规划的优点

HTN规划是基于任务分解的方式来进行问题求解的自动规划模型，与无人机执行任务过程分析方法具有相似性。
1）HTN具有较强的表达能力，能够对实际问题进行知识建模和表示，特别是利用方法模型描述无人机程序性知识。  
2）HTN规划过程具有目标导向特征，将问题求解过程分解为确定目标的完成途径和选择实际目标的最佳方法两个相对独立的子过程，与实际执行任务规划的思考过程具有相似性。  
3）HTN规划过程产生的分层任务网络表达目标和子目标的分解关系，描述了任务规划过程中制定策略涉及的策略点和上下文信息。  
4）HTN规划利用任务分解空间搜索过程代替经典规划模型中的状态空间搜索且搜索空间由建立的方法模型决定，从而提高规划效率，能够用以求解大规模的实际决策过程。  

缺点：依赖性（领域专家知识），不连续性

类似规划器比较：SIADEX
SIADEX同样基于状态规划，能够表达规划过程中的时间约束条件，但是规划过程复杂，无法在计算能力有限的设备上运行，同时需要一个中控节点对当前完全连通网络进行统一调度，反应时间在几分钟到几小时之间。比较与1ms系统规划时间需求，并不适用。

anytime规划器：FPS游戏中NPC（适应性，准确性）

2.全规划流程可视化，一方面由于jsop2规划器对于甲方来说是黑盒，甲方要求能直观看到规划流程，于是我们将规划逻辑抽象提取为树形结构，带偏序和部分循环，利用d3工具可视化；另一方面将得到的规划结果列表通过点亮的方式在树上显示，进一步扩展满足单步、多步、多计划等功能显示；
此外，添加可视化界面修改，用户在清楚看到层次关系后，可以直接在节点上通过右键修改（修改时：捕获修改的数据项，查字典列表，修改值，写回txt，增删状态：txt节点定位（定位表+全局遍历），插入，修改字典）

## 改进：

1.子任务产生的规则，有静态规则改进为动态规则，规则随环境改变，利用偏差解释和当前环境自身状态确定产生什么样的子目标。子任务单独成快，实现复用。1:1改为1：n，根据具体的环境从n中选择具体的子任务。

2.规划扩展到连续效果
方案管理器向其他组件发送指令，监视方案实际执行过程；规划器根据当前系统状态和领域知识，生成规划方案；执行器监视环境中实时产生的事件，更新系统信息，触发规划器对当前执行方案不可行的部分再进行规划。
未来工作还包括HTN，偏差分类以及目标产生的principles

## 性能

单个规划流程在1ms内完成（无干预）

## 无人机通信

默认通信完好，任务重规划模块的数据是从状态感知模块发送过来的，通过socket完成（解耦合，消息队列也可以）

## MVC模型

## socket

## c++/Java类型转换